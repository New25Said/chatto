<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ’¬ Chat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="chat-app">
    <!-- Sidebar -->
    <div id="sidebar">
      <div id="sidebar-header">ðŸ’¬ Chat</div>
      <input type="text" id="search-contact" placeholder="Buscar...">
      <div id="chat-list"></div>
      <button id="create-group-btn">âž• Crear Grupo</button>
    </div>

    <!-- Chat Area -->
    <div id="chat-area">
      <div id="chat-header">Selecciona un chat</div>
      <div id="messages"></div>
      <div id="input-area">
        <input type="text" id="message-input" placeholder="Escribe un mensaje...">
        <button id="send-button">âž¤</button>
      </div>
    </div>
  </div>

  <!-- Modal Crear Grupo -->
  <div class="modal" id="group-modal">
    <div class="modal-content">
      <h3>Crear Grupo</h3>
      <input type="text" id="group-name" placeholder="Nombre del grupo">
      <button id="create-group-confirm">Crear</button>
      <button id="close-group-modal">Cancelar</button>
    </div>
  </div>

  <!-- Script -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentChat = "public"; 
    let nickname = localStorage.getItem("nickname") || prompt("Elige tu nickname:");
    if (!nickname) nickname = "Invitado" + Math.floor(Math.random() * 1000);
    localStorage.setItem("nickname", nickname);

    const chatList = document.getElementById("chat-list");
    const chatHeader = document.getElementById("chat-header");
    const messages = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");

    // Modal
    const groupModal = document.getElementById("group-modal");
    document.getElementById("create-group-btn").onclick = () => groupModal.style.display = "flex";
    document.getElementById("close-group-modal").onclick = () => groupModal.style.display = "none";
    document.getElementById("create-group-confirm").onclick = () => {
      const groupName = document.getElementById("group-name").value.trim();
      if (groupName) {
        socket.emit("createGroup", groupName);
        groupModal.style.display = "none";
        document.getElementById("group-name").value = "";
      }
    };

    // Notificaciones de navegador
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Mostrar mensaje
    function addMessage(chat, from, text) {
      if (chat === currentChat) {
        const msg = document.createElement("div");
        msg.classList.add("message", from === nickname ? "you" : "other");
        msg.textContent = from + ": " + text;
        messages.appendChild(msg);
        messages.scrollTop = messages.scrollHeight;
      } else {
        // marcar como no leÃ­do
        const chatItem = document.querySelector(`[data-chat="${chat}"] .unread-badge`);
        if (chatItem) {
          chatItem.style.display = "inline-block";
        }
        // notificaciÃ³n de navegador
        if (document.hidden && Notification.permission === "granted") {
          new Notification("Nuevo mensaje en " + chat, { body: from + ": " + text });
        }
      }
    }

    // Enviar mensaje
    function sendMessage() {
      const text = messageInput.value.trim();
      if (text) {
        socket.emit("message", { chat: currentChat, from: nickname, text });
        messageInput.value = "";
      }
    }

    sendButton.onclick = sendMessage;
    messageInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    // Recibir mensajes
    socket.on("message", ({ chat, from, text }) => {
      addMessage(chat, from, text);
    });

    // Cargar lista de chats
    socket.on("chatList", chats => {
      chatList.innerHTML = "";
      chats.forEach(chat => {
        const item = document.createElement("div");
        item.classList.add("chat-item");
        item.dataset.chat = chat;
        item.innerHTML = `
          <span class="chat-name">${chat}</span>
          <span class="unread-badge">â€¢</span>
        `;
        item.onclick = () => {
          currentChat = chat;
          chatHeader.textContent = chat;
          messages.innerHTML = "";
          document.querySelectorAll(".unread-badge").forEach(b => b.style.display = "none");
        };
        chatList.appendChild(item);
      });
    });

    // Enviar nickname al server
    socket.emit("setNickname", nickname);
  </script>
</body>
</html>
